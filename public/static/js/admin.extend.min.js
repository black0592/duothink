/**
 * Created by imdante on 2016/9/20.
 */
$(document).ready(function(){
    $(document).on('click','[data-editor-auth-rule]',function(){
        var json = $(this).data('editor-auth-rule');
        var form = $('#ed-auth-rule');
        $.get('/admin/config/ed_auth_rule_calldata.html',{id:json},function(call){
            if(call.code == 200){
                form.find('[name="id"]').attr('value',call.data.id);
                form.find('[name="name"]').attr('value',call.data.name);
                form.find('[name="title"]').attr('value',call.data.title);
                form.find('[name="sort"]').attr('value',call.data.sort);
                form.find('[name="icon"]').attr('value',call.data.icon);
                form.find('[name="status"] option[value="'+call.data.status+'"]').attr('selected','');
                form.find('[name="pid"] option[value="'+call.data.pid+'"]').attr('selected','');
                showModel('ed');
            }
        })
    })
    //定时刷新状态表，保持用户登录状态
    setInterval("$.get('/admin/index/refresh_login_status?spm='+spm+'&t='+ new Date().getTime())",120000);

    $(document).on('click','#mp-account-login-submit',function(){
        $(this).prepend('<i class="am-icon-spinner am-icon-pulse"></i>').addClass('am-disabled');
        var $form = $('#mp-account-login-form');
        if($form['0'].checkValidity()){
            var data = $form.serialize();
            $.post('/plugin/helper/account_login.html',data,function(call){
                if(call.code == 200){
                    var alert_success = $('.am-alert-success');
                    var alert_error = $('.am-alert-danger');
                    var alert_warning = $('.am-alert-warning');
                    var alert;
                    switch (call.code) {
                        case 200:
                            alert = alert_success;
                            break;
                        case 403 || 404:
                            alert = alert_warning;
                            break;
                        default:
                            alert = alert_error;
                            break;
                    }
                    alert.find('p').html(call.msg);
                    alert.fadeIn().delay(5000).fadeOut();
                    if(call.code == 200){
                       setTimeout("window.location.href='/admin/index/index.html'",2000);
                    }
                }
            })
        }else {
            showAlert(403,'请填写必填字段');
        }
        setTimeout('reSubmitState()', 5000);
        return false;
    })
    $(document).on('click','[data-del-spec-id]',function(){
        var id = $(this).data('del-spec-id');
        $('#spec-item-id-'+id).remove();
    })

    //编辑分类
    $(document).on('click','[data-ed-category]',function(){
        var id = $(this).data('ed-category');
        $.get('/admin/category/get_category',{id:id},function(call){
            if(call.code == 200){
                $('#ed-category').find('[name="id"]').attr('value',call.data.id);
                $('#ed-category').find('[name="title"]').attr('value',call.data.title);
                $('#ed-category').find('[name="order"]').attr('value',call.data.order);
                $('#ed-category').find('[name="type"] option[value="'+call.data.type+'"]').attr('selected','');
                showModel('ed-category')
            }else {
                showAlert(call.code,call.msg);
            }
        })
    })
});

/**
 * 添加规格
 * @param openid
 * @returns {boolean}
 * @constructor
 */
var itemId =1;
function WidgetSpecAddItem(){
    var citem = cache('spec_item'),cname = cache('spec_name');
    var a= $('#spec-item'),
        b=$('#spec-price'),
        n=$('#spec-name'),
        c = a.val(),
        d = b.val(),
        e = n.val()
        o=$('[name="openid"]').val(),
        t = $('.am-widget-spec-container');
    if(c =='' || d =='' || n ==''){
        showAlert(403,'规格名称和价格不能为空');
        return false;
    }
    if(citem == c && cname == e){
        showAlert(403,'规格名称和规格名已经存在');
        return false;
    }
    var temp = '<div class="am-form-group am-cf" id="spec-item-id-'+itemId+'">' +
        '<div class="am-u-sm-2"><input type="text" name="spec['+itemId+'][item]" value="'+c+'"></div>'+
        '<div class="am-u-sm-2"><input type="text" name="spec['+itemId+'][name]" value="'+e+'"></div>'+
        '<div class="am-u-sm-2"><input type="text" name="spec['+itemId+'][price]" value="'+d+'"></div>'+
        '<div class="am-u-sm-6"><span class="am-close am-icon-close" data-del-spec-id="'+itemId+'"></span></div>'+
        '</div>';
    t.append(temp);
    itemId++;
    cache('spec_item',c);
    cache('spec_name',e);
}